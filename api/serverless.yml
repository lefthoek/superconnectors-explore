service: superconnectors-api
variablesResolutionMode: 20210326
plugins:
  - serverless-plugin-monorepo
custom:
  parameter_prefix: superconnectors/${opt:stage}
  function_prefix: superconnectors-${opt:stage}
  api: ${self:custom.function_prefix}-graphql
  role: ${ssm:/${self:custom.parameter_prefix}/api/role}

provider:
  name: aws
  runtime: nodejs14.x
  region: eu-west-1
  iam:
    role: ${ssm:/${self:custom.parameter_prefix}/api/role}
    role:
      statements:
        - Effect: Allow
          Action: execute-api:*
          Resource:
            - !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebsocketsApi}/*'
  lambdaHashingVersion: 20201221
  environment:
    SUBSCRIPTIONS_TABLE: ws-subscriptions
    CONNECTIONS_TABLE: ws-connections

functions:
  graphql: 
    handler: dist/handlers.query
    events:
      - http:
          path: graphql
          method: post
          cors: true
      - http:
          path: graphql
          method: get
          cors: true
      - http:
          path: playground
          method: any
          cors: true
    environment:
      SLS_ENVIRONMENT: ${opt:stage}
      HANDLER_NAME: ${self:custom.api}
  subscription:
    handler: dist/handlers.subscription
    events:
      - websocket:
          route: $connect
      - websocket:
          route: $disconnect
      - websocket:
          route: $default
